<!DOCTYPE html><HTML lang="en"><head><meta charset="UTF-8"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><title>Parallel I/O · PencilArrays.jl</title><link href="https://jipolanco.github.io/PencilArrays.jl/PencilIO/" rel="canonical"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script data-main="../assets/documenter.js" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" data-theme-name="documenter-dark" href="../assets/themes/documenter-dark.css" rel="stylesheet" type="text/css"/><link class="docs-theme-link" data-theme-name="documenter-light" data-theme-primary="" href="../assets/themes/documenter-light.css" rel="stylesheet" type="text/css"/><script src="../assets/themeswap.js"></script><link href="../assets/custom.css" rel="stylesheet" type="text/css"/><script src="../assets/matomo.js"></script><script data-outdated-warner="">function maybeAddWarning () {
    const head = document.getElementsByTagName('head')[0];

    // Add a noindex meta tag (unless one exists) so that search engines don't index this version of the docs.
    if (document.body.querySelector('meta[name="robots"]') === null) {
        const meta = document.createElement('meta');
        meta.name = 'robots';
        meta.content = 'noindex';

        head.appendChild(meta);
    };

    // Add a stylesheet to avoid inline styling
    const style = document.createElement('style');
    style.type = 'text/css';
    style.appendChild(document.createTextNode('.outdated-warning-overlay {  position: fixed;  top: 0;  left: 0;  right: 0;  box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);  z-index: 999;  background-color: #ffaba7;  color: rgba(0, 0, 0, 0.7);  border-bottom: 3px solid #da0b00;  padding: 10px 35px;  text-align: center;  font-size: 15px; }  .outdated-warning-overlay .outdated-warning-closer {    position: absolute;    top: calc(50% - 10px);    right: 18px;    cursor: pointer;    width: 12px; }  .outdated-warning-overlay a {    color: #2e63b8; }    .outdated-warning-overlay a:hover {      color: #363636; }'));
    head.appendChild(style);

    const div = document.createElement('div');
    div.classList.add('outdated-warning-overlay');
    const closer = document.createElement('div');
    closer.classList.add('outdated-warning-closer');

    // Icon by font-awesome (license: https://fontawesome.com/license, link: https://fontawesome.com/icons/times?style=solid)
    closer.innerHTML = '<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="times" class="svg-inline--fa fa-times fa-w-11" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 352 512"><path fill="currentColor" d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z"></path></svg>';
    closer.addEventListener('click', function () {
        document.body.removeChild(div);
    });
    let href = '/stable';
    if (window.documenterBaseURL) {
        href = window.documenterBaseURL + '/../stable';
    }
    div.innerHTML = 'This is an old version of the documentation. <br> <a href="' + href + '">Go to the newest version</a>.';
    div.appendChild(closer);
    document.body.appendChild(div);
};

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', maybeAddWarning);
} else {
    maybeAddWarning();
};
</script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img alt="PencilArrays.jl logo" src="../assets/logo.svg"/></a><div class="docs-package-name"><span class="docs-autofit">PencilArrays.jl</span></div><form action="../search/" class="docs-search"><input class="docs-search-query" id="documenter-search-query" name="q" placeholder="Search docs" type="text"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Library</span><ul><li><a class="tocitem" href="../MPITopology/">MPI topology</a></li><li><a class="tocitem" href="../Pencils/">Pencil configurations</a></li><li><a class="tocitem" href="../PencilArrays/">Array wrappers</a></li><li><a class="tocitem" href="../Transpositions/">Global MPI operations</a></li><li class="is-active"><a class="tocitem" href="">Parallel I/O</a><ul class="internal"><li><a class="tocitem" href="#setting_up_parallel_hdf5"><span>Setting-up Parallel HDF5</span></a></li><li><a class="tocitem" href="#Library"><span>Library</span></a></li></ul></li><li><a class="tocitem" href="../PencilArrays_timers/">Measuring performance</a></li><li><input class="collapse-toggle" id="menuitem-2-7" type="checkbox"/><label class="tocitem" for="menuitem-2-7"><span class="docs-label">Internals</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../PermutationUtils/">Permutation tools</a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Library</a></li><li class="is-active"><a href="">Parallel I/O</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="">Parallel I/O</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/jipolanco/PencilArrays.jl/blob/master/docs/src/PencilIO.md#L" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" href="#" id="documenter-settings-button" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" href="#" id="documenter-sidebar-button"></a></div></header><article class="content" id="documenter-page"><h1 id="PencilIO_module"><a class="docs-heading-anchor" href="#PencilIO_module">Parallel I/O</a><a id="PencilIO_module-1"></a><a class="docs-heading-anchor-permalink" href="#PencilIO_module" title="Permalink"></a></h1><p>The <code>PencilArrays.PencilIO</code> module contains functions for saving and loading <a href="../PencilArrays/#PencilArrays.PencilArray"><code>PencilArray</code></a>s to disk using MPI-IO. Parallel I/O is performed using Parallel HDF5 through the <a href="https://github.com/JuliaIO/HDF5.jl">HDF5.jl</a> package.</p><p>The implemented approach consists in storing the data coming from different MPI processes in a single file. This strategy scales better in terms of number of files, and is more convenient, than that of storing one file per process. However, the performance is very sensitive to the configuration of the underlying file system. In distributed file systems such as <a href="https://en.wikipedia.org/wiki/Lustre_(file_system)">Lustre</a>, it is worth tuning parameters such as the stripe count and stripe size (see for instance the <a href="https://portal.hdfgroup.org/display/HDF5/Parallel+HDF5">Parallel HDF5 page</a> for more information).</p><h2 id="setting_up_parallel_hdf5"><a class="docs-heading-anchor" href="#setting_up_parallel_hdf5">Setting-up Parallel HDF5</a><a id="setting_up_parallel_hdf5-1"></a><a class="docs-heading-anchor-permalink" href="#setting_up_parallel_hdf5" title="Permalink"></a></h2><p>Parallel HDF5 is not enabled in the default installation of HDF5.jl. For Parallel HDF5 to work, the HDF5 C libraries wrapped by HDF5.jl must be compiled with parallel support and linked to the specific MPI implementation that will be used for parallel I/O. HDF5.jl must be explicitly instructed to use parallel-enabled HDF5 libraries available in the system. Similarly, MPI.jl must be instructed to use the corresponding MPI libraries. This is detailed in the sections below.</p><p>Parallel-enabled HDF5 libraries are usually included in computing clusters and linked to the available MPI implementations. They are also available via the package manager of a number of Linux distributions. (For instance, Fedora includes the <code>hdf5-mpich-devel</code> and <code>hdf5-openmpi-devel</code> packages, respectively linked to the MPICH and OpenMPI libraries in the Fedora repositories.)</p><p>The following step-by-step guide assumes one already has access to parallel-enabled HDF5 libraries linked to an existent MPI installation.</p><h3 id=".-Using-system-provided-MPI-libraries"><a class="docs-heading-anchor" href="#.-Using-system-provided-MPI-libraries">1. Using system-provided MPI libraries</a><a id=".-Using-system-provided-MPI-libraries-1"></a><a class="docs-heading-anchor-permalink" href="#.-Using-system-provided-MPI-libraries" title="Permalink"></a></h3><p>Set the environment variable <code>JULIA_MPI_BINARY=system</code> and then run <code>]build MPI</code> from Julia. For more control, one can also set the <code>JULIA_MPI_PATH</code> environment variable to the top-level installation directory of the MPI library.</p><p>See the <a href="https://juliaparallel.github.io/MPI.jl/stable/configuration/#Using-a-system-provided-MPI-1">MPI.jl docs</a> for details.</p><h3 id=".-Using-parallel-HDF5-libraries"><a class="docs-heading-anchor" href="#.-Using-parallel-HDF5-libraries">2. Using parallel HDF5 libraries</a><a id=".-Using-parallel-HDF5-libraries-1"></a><a class="docs-heading-anchor-permalink" href="#.-Using-parallel-HDF5-libraries" title="Permalink"></a></h3><p>Set the <code>JULIA_HDF5_LIBRARY_PATH</code> environment variable to the directory where the HDF5 libraries compiled with parallel support are found. Then run <code>]build HDF5</code> from Julia. Note that the selected HDF5 library must be linked to the MPI library chosen in the previous section. For the set-up to be persistent across HDF5.jl updates, consider setting <code>JULIA_HDF5_LIBRARY_PATH</code> in <code>~/.bashrc</code> or similar.</p><p>See the <a href="https://github.com/JuliaIO/HDF5.jl#installation">HDF5.jl README</a> for details.</p><h3 id=".-Loading-PencilIO"><a class="docs-heading-anchor" href="#.-Loading-PencilIO">3. Loading PencilIO</a><a id=".-Loading-PencilIO-1"></a><a class="docs-heading-anchor-permalink" href="#.-Loading-PencilIO" title="Permalink"></a></h3><p>In the <code>PencilIO</code> module, the HDF5.jl package is lazy-loaded using <a href="https://github.com/JuliaPackaging/Requires.jl">Requires</a>. This means that, in Julia code, <code>PencilArrays</code> must be loaded <em>after</em><code>HDF5</code> for parallel I/O functionality to be available.</p><p>The following order of <code>using</code>s ensures that parallel I/O support is available:</p><pre><code class="language-julia">using MPI
using HDF5
using PencilArrays</code></pre><h2 id="Library"><a class="docs-heading-anchor" href="#Library">Library</a><a id="Library-1"></a><a class="docs-heading-anchor-permalink" href="#Library" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-binding" href="#PencilArrays.PencilIO.ph5open" id="PencilArrays.PencilIO.ph5open"><code>PencilArrays.PencilIO.ph5open</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia">ph5open([f::Function], filename, [mode="r"], comm::MPI.Comm,
        [info::MPI.Info=MPI.Info()], prop_lists...) -&gt; HDF5.File</code></pre><p>Open parallel HDF5 file.</p><p>This function is a thin wrapper over <code>HDF5.h5open</code>. It converts MPI.jl types (<code>MPI.Comm</code> and <code>MPI.Info</code>) to their counterparts in HDF5.jl. It also throws an informative error if the loaded HDF5 libraries do not include parallel support.</p><p><strong>Property lists</strong></p><p>This function automatically sets the <a href="https://portal.hdfgroup.org/display/HDF5/H5P_SET_FAPL_MPIO"><code>fapl_mpio</code></a> file access property list to the given MPI communicator and info object. Other property lists should be given as name-value pairs, following the <a href="https://github.com/JuliaIO/HDF5.jl/blob/master/doc/hdf5.md#passing-parameters"><code>h5open</code> syntax</a>.</p><p>Property lists are passed to <a href="https://portal.hdfgroup.org/display/HDF5/H5F_CREATE"><code>h5f_create</code></a>. The following property types are recognised:</p><ul><li><a href="https://portal.hdfgroup.org/display/HDF5/File+Creation+Properties">file creation properties</a>,</li><li><a href="https://portal.hdfgroup.org/display/HDF5/File+Access+Properties">file access properties</a>.</li></ul></div><a class="docs-sourcelink" href="https://github.com/jipolanco/PencilArrays.jl/blob/4849a4f1f825b54298c1d1686c61f7e72288e7ac/src/PencilIO/hdf5.jl#LL48-L74" target="_blank">source</a></section></article><article class="docstring"><header><a class="docstring-binding" href="#Base.setindex!" id="Base.setindex!"><code>Base.setindex!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia">setindex!(g::Union{HDF5File,HDF5Group}, x::MaybePencilArrayCollection,
          name::String, prop_lists...; chunks=false, collective=true)</code></pre><p>Write <a href="../PencilArrays/#PencilArrays.PencilArray"><code>PencilArray</code></a> or <a href="../PencilArrays/#PencilArrays.PencilArrayCollection"><code>PencilArrayCollection</code></a> to parallel HDF5 file.</p><p>For performance reasons, the memory layout of the data is conserved. In other words, if the dimensions of a <code>PencilArray</code> are permuted in memory, then the data is written in permuted form.</p><p>In the case of a <code>PencilArrayCollection</code>, each array of the collection is written as a single component of a higher-dimension dataset.</p><p><strong>Optional arguments</strong></p><ul><li><p>if <code>chunks=true</code>, data is written in chunks, with roughly one chunk per MPI process. This may (or may not) improve performance in parallel filesystems.</p></li><li><p>if <code>collective=true</code>, the dataset is written collectivelly. This is usually recommended for performance.</p></li><li><p>additional property lists may be specified by name-value pairs in <code>prop_lists</code>, following the <a href="https://github.com/JuliaIO/HDF5.jl/blob/master/doc/hdf5.md#passing-parameters">HDF5.jl syntax</a>. These property lists take precedence over keyword arguments. For instance, if the <code>"dxpl_mpio", HDF5.H5FD_MPIO_COLLECTIVE</code> pair is passed, then the value of the <code>collective</code> argument is ignored.</p></li></ul><p><strong>Property lists</strong></p><p>Property lists are passed to <a href="https://portal.hdfgroup.org/display/HDF5/H5D_CREATE2"><code>h5d_create</code></a> and <a href="https://portal.hdfgroup.org/display/HDF5/H5D_WRITE"><code>h5d_write</code></a>. The following property types are recognised:</p><ul><li><a href="https://portal.hdfgroup.org/display/HDF5/Attribute+and+Link+Creation+Properties">link creation properties</a>,</li><li><a href="https://portal.hdfgroup.org/display/HDF5/Dataset+Creation+Properties">dataset creation properties</a>,</li><li><a href="https://portal.hdfgroup.org/display/HDF5/Dataset+Access+Properties">dataset access properties</a>,</li><li><a href="https://portal.hdfgroup.org/display/HDF5/Dataset+Transfer+Properties">dataset transfer properties</a>.</li></ul><p><strong>Example</strong></p><p>Open a parallel HDF5 file and write some <code>PencilArray</code>s to the file:</p><pre><code class="language-julia">pencil = Pencil(#= ... =#)
u = PencilArray{Float64}(undef, pencil)
v = similar(u)

# [fill the arrays with interesting values...]

comm = get_comm(u)
info = MPI.Info()

ph5open("filename.h5", "w", comm, info) do ff
    ff["u", chunks=true] = u
    ff["uv"] = (u, v)  # this is a two-component PencilArrayCollection (assuming equal dimensions of `u` and `v`)
end</code></pre></div><a class="docs-sourcelink" href="https://github.com/jipolanco/PencilArrays.jl/blob/4849a4f1f825b54298c1d1686c61f7e72288e7ac/src/PencilIO/hdf5.jl#LL97-L158" target="_blank">source</a></section></article><article class="docstring"><header><a class="docstring-binding" href="#Base.read!" id="Base.read!"><code>Base.read!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia">read!(g::Union{HDF5File,HDF5Group}, x::MaybePencilArrayCollection,
      name::String, prop_lists...; collective=true)</code></pre><p>Read <a href="../PencilArrays/#PencilArrays.PencilArray"><code>PencilArray</code></a> or <a href="../PencilArrays/#PencilArrays.PencilArrayCollection"><code>PencilArrayCollection</code></a> from parallel HDF5 file.</p><p>See <a href="#Base.setindex!"><code>setindex!</code></a> for details on optional arguments.</p><p><strong>Property lists</strong></p><p>Property lists are passed to <a href="https://portal.hdfgroup.org/display/HDF5/H5D_OPEN2"><code>h5d_open</code></a> and <a href="https://portal.hdfgroup.org/display/HDF5/H5D_READ"><code>h5d_read</code></a>. The following property types are recognised:</p><ul><li><a href="https://portal.hdfgroup.org/display/HDF5/Dataset+Access+Properties">dataset access properties</a>,</li><li><a href="https://portal.hdfgroup.org/display/HDF5/Dataset+Transfer+Properties">dataset transfer properties</a>.</li></ul><p><strong>Example</strong></p><p>Open a parallel HDF5 file and read some <code>PencilArray</code>s:</p><pre><code class="language-julia">pencil = Pencil(#= ... =#)
u = PencilArray{Float64}(undef, pencil)
v = similar(u)

comm = get_comm(u)
info = MPI.Info()

ph5open("filename.h5", "r", comm, info) do ff
    read!(ff, u, "u")
    read!(ff, (u, v), "uv")
end</code></pre></div><a class="docs-sourcelink" href="https://github.com/jipolanco/PencilArrays.jl/blob/4849a4f1f825b54298c1d1686c61f7e72288e7ac/src/PencilIO/hdf5.jl#LL193-L228" target="_blank">source</a></section></article><article class="docstring"><header><a class="docstring-binding" href="#PencilArrays.PencilIO.hdf5_has_parallel" id="PencilArrays.PencilIO.hdf5_has_parallel"><code>PencilArrays.PencilIO.hdf5_has_parallel</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia">hdf5_has_parallel() -&gt; Bool</code></pre><p>Returns <code>true</code> if the loaded HDF5 libraries support MPI-IO.</p></div><a class="docs-sourcelink" href="https://github.com/jipolanco/PencilArrays.jl/blob/4849a4f1f825b54298c1d1686c61f7e72288e7ac/src/PencilIO/hdf5.jl#LL30-L34" target="_blank">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Transpositions/">« Global MPI operations</a><a class="docs-footer-nextpage" href="../PencilArrays_timers/">Measuring performance »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label></p><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div><p></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Wednesday 2 September 2020 00:31">Wednesday 2 September 2020</span>. Using Julia version 1.5.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></HTML>